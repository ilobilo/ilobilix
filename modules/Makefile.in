THISDIR := $(realpath $(shell pwd))
MODULE := $(THISDIR)/$(notdir $(THISDIR)).ko

MODULE_CFLAGS ?= 
MODULE_CXXFLAGS ?= 
MODULE_ASFLAGS ?= 
MODULE_LDFLAGS ?= 

CFLAGS += $(MODULE_CFLAGS)
CXXFLAGS += $(MODULE_CXXFLAGS)
ASFLAGS += $(MODULE_ASFLAGS)
LDFLAGS += $(MODULE_LDLAGS)

-include Makefile.in

override LDFLAGS += \
	-relocatable    \
	-nostdlib       \
	-static

override CCFLAGS :=              \
	$(INCLUDES) $(MACROS)        \
	-target $(TARGET)            \
	-ffreestanding               \
	-fno-stack-protector         \
	-fno-omit-frame-pointer      \
	-fno-pic -fno-pie            \
	-Werror -Wall -Wextra        \
	-Wno-error=\#warnings        \
	-Wno-unused-parameter        \
	-Wno-builtin-macro-redefined \
	-Ofast -pipe -MMD

ifeq ($(ARCH),x86_64)
    override CCFLAGS +=   \
        -march=x86-64     \
        -mabi=sysv        \
        -msoft-float      \
        -mno-mmx          \
        -mno-sse          \
        -mno-sse2         \
        -mno-red-zone     \
        -mcmodel=large

    override ASFLAGS += \
        -masm=intel
else ifeq ($(ARCH),aarch64)
    override CCFLAGS +=     \
        -mgeneral-regs-only \
        -mcmodel=small
endif

ifdef MODUBSAN
    override CCFLAGS += -fsanitize=undefined
endif

override CFLAGS += \
	$(CCFLAGS)     \
	-std=$(CVERSION)

override CXXFLAGS +=           \
	$(CCFLAGS)                 \
	-std=$(CXXVERSION)         \
	-fno-exceptions            \
	-fno-rtti                  \
	-Wno-user-defined-literals

override ASFLAGS += \
	$(CCFLAGS)

override CFILES := $(shell find $(THISDIR)/ -type f -name '*.c')
override CXXFILES := $(shell find $(THISDIR)/ -type f -name '*.cpp')
override ASFILES := $(shell find $(THISDIR)/ -type f -name '*.S')

override OBJ = $(CFILES:.c=.c.o) $(CXXFILES:.cpp=.cpp.o) $(ASFILES:.S=.S.o)
override HDP = $(CFILES:.c=.c.d) $(CXXFILES:.cpp=.cpp.d) $(ASFILES:.S=.S.d)

.PHONY: all
all: $(MODULE)
ifndef NOCLEAN
	rm -f $(OBJ) $(HDP)
endif

$(MODULE): $(OBJ)
	@printf "LD\t%s\n" $(MODULE:$(ROOTDIR)/%=%)
	$(LD) $(LDFLAGS) $(OBJ) -o $@

-include $(HDP)

%.c.o: %.c
	@printf "CC\t%s\n" $(<:$(ROOTDIR)/%=%)
	$(CC) $(CFLAGS) -D__FILE__='"$(<:$(ROOTDIR)/%=%)"' -c $< -o $@

%.cpp.o: %.cpp
	@printf "CXX\t%s\n" $(<:$(ROOTDIR)/%=%)
	$(CXX) $(CXXFLAGS) -D__FILE__='"$(<:$(ROOTDIR)/%=%)"' -c $< -o $@

%.S.o: %.S
	@printf "AS\t%s\n" $(<:$(ROOTDIR)/%=%)
	$(CC) $(ASFLAGS) -D__FILE__='"$(<:$(ROOTDIR)/%=%)"' -c $< -o $@